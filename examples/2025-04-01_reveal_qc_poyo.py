# %% List of Pids from Matt / Cole
PIDS = [
    '22609d51-0a6a-425d-a3ef-eeb43a9ba350',
    '94fcff55-2da2-4366-a2c7-2f58c05b54dc',
    '8dfb86c8-d45c-46c4-90ec-33078014d434',
    '697d9e03-edc6-430a-ae76-94628c510161',
    '567b4da5-6ee6-4300-9f40-442930c2b1ca',
    'bef05a5c-68c3-4513-87c7-b3151c88da8e',
    'd3507787-60c8-4cea-a61e-0c708b4361d8',
    'b1455ca8-3999-4eb8-9e1e-5c8d0d2e5719',
    '0a45a464-a909-4b7c-a3e0-cd6cfb4262e4',
    'f142d2c6-6d85-4e9d-9c56-07620486e068',
    'c64201ea-262e-45fe-8f41-5a074780cd59',
    'fe41986d-4966-4a77-af7e-e7f71c25aec5',
    'f68d9f26-ac40-4c67-9cbf-9ad1851292f7',
    '3b729602-20d5-4be8-a10e-24bde8fc3092',
    'ce0dc660-f19e-46a3-94f9-646bebae6805',
    '4762e8ed-4d94-4fd7-9522-e927f5ffca74',
    'c3ef78d5-7c75-48a4-96b7-f8ecc91c2eca',
    '8b31b4bd-003e-4816-a3bf-2df4cc3558f8',
    'a21bade7-5be7-4a17-a9b9-ddee453e6260',
    '703f2cd2-377a-48ec-979a-135863169671',
    '80c7f589-733c-4f23-abf3-ade8c79f0a3b',
    'a44a9942-0667-4d49-9047-40d2256c9854',
    'e9c04e7e-c075-4ee3-9750-dff255ec7e84',
    'f72e60c3-3593-466a-afaf-91145c44fb2b',
    '0c15a331-09ac-445c-837f-6afb5e377e56',
    'bb7a5967-56ae-4193-920d-142710b4f07d',
    '5eebb5d6-cf9b-49a0-b297-0701c4d90173',
    '81ef1ec7-dbcc-410f-9bff-b21a62a909fd',
    'ac680ec5-6f89-4739-9848-9d76fc0e017f',
    '59b7a543-8827-4157-a4f6-d5d0e50fdf39',
    '9861fa24-d998-4ef5-9606-89002b8706fc',
    '81f35c52-f7bb-4342-8f91-1837a068c045',
    'e6749a77-4b65-4186-a47e-63562386cecd',
    '0143d3fe-79c2-4922-8332-62c3e4e0ba85',
    'd8ccc6bb-f0d9-494a-b682-f12c73e228c6',
    'ec1e2af7-c107-4a18-ab05-cefb9174d516',
    'df07180e-268e-489c-826e-40cb6f63d3a5',
    '5bfcf68f-4e0b-46f8-a9e3-8e919d5ddd1c',
    '49c2ea3d-2b50-4e8a-b124-9e190960784e',
    'fb962a77-ed5a-40e0-bfdf-b3220427c55e',
    '93a76e52-fed0-494f-8852-2b978f56a8e7',
    '0b877123-0902-4432-b789-c4c6cc681df4',
    '6d9b6393-6729-4a15-ad08-c6838842a074',
    '511afaa5-fdc4-4166-b4c0-4629ec5e652e',
    '47403ac7-6635-4477-9477-18ff605ff5d4',
    '6981808a-357c-4ffd-9989-33160ba9e256',
    '7a620688-66cb-44d3-b79b-ccac1c8ba23e',
    'b72b22c2-6e9d-4604-9910-20c0e1a467d7',
    '7cb5128d-aaf5-4859-a236-527bff0f3c76',
    '00c425fd-ec3e-4cd2-b8af-c0bc0c4bdd44',
    '43436b4b-0431-407f-b83d-d657ec22b5c6',
    'edc82c06-83fd-44be-a41e-52fdeea728b4',
    '298e2a70-9801-45f0-b91c-d6bb9718427e',
    '2564dc27-4eda-4fc3-a151-c13475796ee1',
    'a450558e-195f-44ff-979b-6b6420c9621b',
    '6e61f777-90b9-4656-af30-9ed54d426c5a',
    '92822789-608f-44a6-ad64-fe549402b2df',
    'd3deaed9-34b7-41da-bd62-961750cb9ca0',
    'cc72fdb7-92e8-47e6-9cea-94f27c0da2d8',
    '31258665-fbe8-4599-9c5f-dbc0eeee9c51',
    'e4ce2e94-6fb9-4afe-acbf-6f5a3498602e',
    '27109779-1b15-4d74-893f-08216d231307',
    'a8a59fc3-a658-4db4-b5e8-09f1e4df03fd',
    '9dff5593-e781-41a3-a6f9-20d06085e4f8',
    '1a924329-65aa-465d-b201-c2dd898aebd0',
    '9915765e-ff15-4371-b1aa-c2ef1db8a254',
    'b114e7e0-92b3-43bb-9529-53860e52606d',
    'a91e4882-d3aa-4339-8b14-e94fa419f328',
    'e033ef96-3590-4e52-bb01-6c6d75bab083',
    'c1014051-d06b-4f85-9887-e7c42a94baf2',
    '85bdeae3-269b-4e39-bd9b-2b0d95aff2fa',
    '623bb859-eb7c-4739-ba18-28ecad1d9fbb',
    'c5b9e063-f640-4936-b851-f7602cb6659b',
    'd1d9defc-6f73-489f-9f14-2c0b5e970b2d',
    '79e56114-a12b-4571-bee3-a5cdd2145ea1',
    '769b42dc-acf3-4079-b09e-ec979568d297',
    '53b3a7c6-ae42-49da-b69c-69e55a43a427',
    '22f26d69-0b30-450e-9618-ee801b720e0a',
    'ec2fbc3e-cb2b-48cb-a521-3a6ca15e244c',
    'c893c0a3-5597-49cf-baa1-60efdfdef542',
    '0a85a28b-e9e3-44ec-ad4d-88ba9116ff63',
    'cc701ed3-84b6-4b8e-8390-2e3f54414b19',
    'd004f105-9886-4b83-a59a-f9173131a383',
    '478de1ce-d7e7-4221-9365-2abdc6e88fb6',
    'a63a7248-9393-478b-9478-64f421ef5eb8',
    'dd75e810-a399-4364-9d4a-517312cf3010',
    '88e148d2-d554-42c2-9c41-cc6369f98c45',
    'c44adf4f-3d1c-491f-88e4-c516cc910bd8',
    'b9faf068-fd1c-4568-8a1a-f503eed6f726',
    '2ce1d485-ebce-41a2-a5ce-aa109d5a13a3',
    '17fa2600-6349-4b6f-a7e4-d8ea5558fa12',
    'ee3345e6-540d-4cea-9e4a-7f1b2fb9a4e4',
    'ecd07b7e-6450-4e31-bef1-f195129eb3d3',
    '12c0f3a9-518e-4dac-9651-5d95c2b4730f',
    '81950362-ed95-4662-997f-e119bbd594d1',
    '33cde267-919e-4c4d-9105-814787499837',
    '379105fd-dbb1-40d9-8a51-ae5a8ef8df04',
    '37137b1d-34d4-4183-9796-abfc9ffb6abe',
    '32e30a72-5f18-4aff-81c3-4553531b2d75',
    'd0046384-16ea-4f69-bae9-165e8d0aeacf',
    '6a7544a8-d3d4-44a1-a9c6-7f4d460feaac',
    '4d2e7e49-5b08-4914-afa6-fd311d957082',
    'e22d047c-5beb-4e5b-9a3d-53b637743856',
    '310c60b6-d68f-4018-a86a-3668ce296837',
    'f7c49002-6565-4314-83f7-19b9a16d8e61',
    'd70f3604-b3cc-41b0-967a-f6619b2586a7',
    '06b677d6-b074-4444-bd4a-3235a310e6e0',
    'a759e857-fd8f-4653-a397-c48547230427',
    '4836a465-c691-4852-a0b1-dcd2b1ce38a1',
    'e089d4d9-0a74-4ebc-951d-67098305e06b',
    'c5fd185f-1c5a-4aad-9795-43c4ccf8ea94',
    'd7187e4f-7bfe-42b3-9e36-761c76eb6e8f',
    'f0c390da-d8e3-4b5f-8df7-bd2f153ed01b',
    'e40193d5-8158-40a1-924b-5a01ed2565dc',
    '9866c08f-acce-4291-b94d-d9835e62f835',
    'd552cffa-b662-40bd-b1e3-98d0a8face2c',
    'a464fc97-1391-4bbe-9aef-73a79975d27f',
    'f1c3cf0a-f3ad-479b-8dd2-7d60ab6d03ff',
    'e5bd461c-a713-4b3c-b165-a132a711e59d',
    'd65ab768-bd77-4719-acb9-677abca4e9d8',
    '5e8ac11b-959a-49ab-a6a3-8a3397e1df0e',
    '18d316bf-d322-4c5c-814e-a58147f7bf5f',
    'afecbc7f-10e3-40af-b091-cca9e8df6108',
    '4f922a5b-5014-455d-8cd5-7caed78af615',
    'bf827e50-eed3-4984-908e-c48ffbeae7b5',
    '81a1cbae-60b6-4013-9511-1bf3855387a2',
    'c9664185-d3fd-4e0e-89cf-77c402038938',
    '5544da75-8d34-47cb-9092-1f91e713e79c',
    '77121d92-6dde-4243-ab54-0a99efa22e99',
    'd5e5311c-8beb-4f8f-b798-3e9bfa6bcdd8',
    'b8f3a7c3-b700-446b-8d29-69691c0e3b1d',
    'fd6d686b-eae1-44cb-adbb-159c69c85827',
    '6104a953-589c-4661-bed9-a81ccef7d0be',
    'f475ae14-9415-453e-b800-1480ea1c868d',
    '069c2674-80b0-44b4-a3d9-28337512967f',
    '38e9e5b8-db29-4158-a09d-cc1de4a1365a',
    '1f5d62cb-814f-4ab2-b6af-7557ea04d56a',
    '234c9e15-79a4-4e8a-8263-8b06cfbcbe7d',
    'a44bd77c-de9c-49cc-85e5-354aa9f1eb98',
    '0566938b-245d-4e5f-89ee-59d53a44f065',
    'f2803f8c-a37b-42dd-9f20-84bdc90b21e2',
    '6925a312-966c-4e41-b79e-4594da57a2ee',
    '9b5fec96-9f19-4ddf-ba1c-3175e15245e9',
    '9338f8bb-e097-46d8-81b4-7f37beb4d308',
    'c6e294f7-5421-4697-8618-8ccc9b0269f6',
    '8c732bf2-639d-496c-bf82-464bc9c2d54b',
    '01937b3b-8719-43c3-b5bd-14e6b0cf2802',
    '5135e93f-2f1f-4301-9532-b5ad62548c49',
    '0ffa052a-fe3f-46c2-999d-43bd56b7826e',
    'a6b71993-165b-4c43-845c-c062fe7d7a11',
    'bf746764-78e0-4b9c-bdf6-65b6ff45745d',
    '24149f5c-2984-4b48-922b-3cd1452cd4bd'
]

# %% Step 1: Create the reveal deck of images
import joblib
from pathlib import Path
import tqdm

import pandas as pd
import numpy as np

from one.api import ONE
import iblatlas.atlas
import reveal.plots

one = ONE(base_url='https://alyx.internationalbrainlab.org')
OVERWRITE = True
path_reveal = Path(f"/home/olivier/scratch/reveal_poyo")
path_reveal.mkdir(parents=True, exist_ok=True)
regions = iblatlas.atlas.BrainRegions()


def make_pid_reveal_figures_multiprocessing(pid):
    try:
        reveal.plots.pid_electrophysiology_qc(
            pid=pid,
            path_reveal=path_reveal,
            regions=regions,
            one=one
        )
    except Exception as e:
        for _ in range(30):
            print(f"Error processing PID {pid}: {str(e)}")

jobs = []
for pid in PIDS:
    jobs.append(joblib.delayed(make_pid_reveal_figures_multiprocessing)(pid))

list(tqdm.tqdm(joblib.Parallel(return_as='generator', n_jobs=8)(jobs)))

# %% Builds the website locally
from reveal.api import RevealSite

c = 0
deck = []
for i, pid in enumerate(PIDS):
    path_pid = path_reveal.joinpath(pid)
    png_images = sorted(list(path_pid.glob('*.png')))
    if len(png_images) < 8:
        continue
    c += 1
    print(f"PID {pid} done")
    deck.append(np.array([
        dict(image_path=png_images[0], title=f"{pid[:8]}: Raster all units", post=pid),
        dict(image_path=png_images[1], title=f"{pid[:8]}: Raster good units", post=pid),
        dict(image_path=png_images[2], image_path_compare=png_images[3], title=f"{pid[:8]}: raw data snippet 1/3", post=pid),
        dict(image_path=png_images[4], image_path_compare=png_images[5], title=f"{pid[:8]}: raw data snippet 2/3", post=pid),
        dict(image_path=png_images[6], image_path_compare=png_images[7], title=f"{pid[:8]}: raw data snippet 3/3", post=pid),
        ])[np.newaxis, :])
print(c, c / len(PIDS))

reveal_path = Path.home().joinpath('Documents/Reveal/reveal.internationalbrainlab.org')
site = RevealSite(deck, name='foundation_qc', reveal_path=reveal_path)
site.build(theme='serif')
site.open()

# %% Commands to upload to AWS
print(f"aws --profile ucl s3 cp {reveal_path}/foundation_qc.html s3://reveal.internationalbrainlab.org/foundation_qc.html")
print(f"aws --profile ucl s3 sync {reveal_path}/images/foundation_qc s3://reveal.internationalbrainlab.org/images/foundation_qc")


